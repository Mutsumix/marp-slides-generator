name: Build and Deploy Preview

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'slides/**'
  push:
    branches:
      - main
    paths:
      - 'slides/**'

jobs:
  build-preview:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Marp CLI
        run: |
          npm install -g @marp-team/marp-cli
      
      - name: Install dependencies
        run: |
          if [ -f package.json ]; then
            npm install
          fi
      
      - name: Find changed slides
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Get changed files in PR
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^slides/' || true)
          else
            # Get changed files in push
            CHANGED_FILES=$(git diff --name-only HEAD~1...HEAD | grep '^slides/' || true)
          fi
          
          # Extract unique slide directories
          SLIDE_DIRS=$(echo "$CHANGED_FILES" | sed 's|/[^/]*$||' | sort -u | grep '^slides/' || true)
          
          echo "Changed slide directories:"
          echo "$SLIDE_DIRS"
          
          # Save to output
          echo "dirs<<EOF" >> $GITHUB_OUTPUT
          echo "$SLIDE_DIRS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Build slides
        if: steps.changed.outputs.dirs != ''
        run: |
          # Create output directory
          mkdir -p build
          
          # Process each changed slide directory
          echo "${{ steps.changed.outputs.dirs }}" | while read -r dir; do
            if [ -n "$dir" ] && [ -f "$dir/slide.md" ]; then
              echo "Building $dir..."
              
              # Create output directory for this slide
              OUTPUT_DIR="build/$dir"
              mkdir -p "$OUTPUT_DIR"
              
              # Generate HTML with speaker notes
              marp "$dir/slide.md" \
                --html \
                --allow-local-files \
                --theme-set ./themes \
                -o "$OUTPUT_DIR/index.html"
              
              # Generate PDF
              marp "$dir/slide.md" \
                --pdf \
                --allow-local-files \
                --theme-set ./themes \
                -o "$OUTPUT_DIR/slide.pdf"
              
              # Copy images if exists
              if [ -d "$dir/images" ]; then
                cp -r "$dir/images" "$OUTPUT_DIR/"
              fi
              
              # Copy to source directory for persistence
              cp -r "$OUTPUT_DIR"/* "$dir/output/" 2>/dev/null || mkdir -p "$dir/output" && cp -r "$OUTPUT_DIR"/* "$dir/output/"
              
              echo "âœ… Built: $dir"
            fi
          done
      
      - name: Ensure build directory with default content
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p build
          if [ ! -f build/index.html ]; then
            cat > build/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Marp Slides Generator</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 2rem;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
              }
              .container {
                background: white;
                border-radius: 10px;
                padding: 2rem;
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
              }
              h1 { color: #333; }
              p { color: #666; line-height: 1.6; }
              a { color: #667eea; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ğŸ“Š Marp Slides Generator</h1>
              <p>ã¾ã ã‚¹ãƒ©ã‚¤ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
              <p>ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½œæˆã™ã‚‹ã«ã¯ï¼š</p>
              <ol>
                <li><a href="https://github.com/Mutsumix/marp-slides-generator/issues/new/choose">Issue ã‚’ä½œæˆ</a></li>
                <li>ãƒ•ã‚©ãƒ¼ãƒ ã«å¿…è¦äº‹é …ã‚’è¨˜å…¥</li>
                <li>AIã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆã—ã¦è²¼ã‚Šä»˜ã‘</li>
                <li>è‡ªå‹•çš„ã«PRãŒä½œæˆã•ã‚Œã¾ã™</li>
              </ol>
              <p><a href="https://github.com/Mutsumix/marp-slides-generator">â†’ ãƒªãƒã‚¸ãƒˆãƒªã‚’è¦‹ã‚‹</a></p>
            </div>
          </body>
          </html>
          EOF
          fi
      
      - name: Setup Pages (for main branch)
        if: github.ref == 'refs/heads/main'
        uses: actions/configure-pages@v4
      
      - name: Upload artifact (for main branch)
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build
      
      - name: Deploy to GitHub Pages (for main branch)
        if: github.ref == 'refs/heads/main'
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Upload preview artifacts (for PR)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: slide-preview-${{ github.event.pull_request.number }}
          path: build/
          retention-days: 7
      
      - name: Comment PR with preview info
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const changedDirs = `${{ steps.changed.outputs.dirs }}`.split('\n').filter(Boolean);
            
            if (changedDirs.length === 0) return;
            
            let comment = `## ğŸ“Š ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼\n\n`;
            comment += `ä»¥ä¸‹ã®ã‚¹ãƒ©ã‚¤ãƒ‰ãŒãƒ“ãƒ«ãƒ‰ã•ã‚Œã¾ã—ãŸï¼š\n\n`;
            
            for (const dir of changedDirs) {
              const slideName = dir.replace('slides/', '');
              comment += `### ğŸ“ ${slideName}\n`;
              comment += `- ğŸ“„ HTMLãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½\n`;
              comment += `- ğŸ“‘ PDF: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½\n\n`;
            }
            
            comment += `---\n\n`;
            comment += `**ãƒãƒ¼ã‚¸å¾Œã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL:**\n`;
            comment += `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/\n\n`;
            comment += `*æ³¨: ãƒãƒ¼ã‚¸å¾Œã€GitHub Pagesã§å…¬é–‹ã•ã‚Œã¾ã™*`;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('## ğŸ“Š ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }