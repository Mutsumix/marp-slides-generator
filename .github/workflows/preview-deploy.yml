name: Build and Deploy Slides

on:
  push:
    branches:
      - main
    paths:
      - 'slides/**/*.md'

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli@latest
      
      - name: Build all HTML slides
        run: |
          mkdir -p build
          
          echo "Building all slides for complete site generation..."
          
          # Build ALL slide.md files to ensure complete site
          for file in slides/*/slide.md; do
            if [ ! -f "$file" ]; then
              continue
            fi
            
            echo "Building: $file"
            slide_dir=$(dirname "$file")
            output_dir="build/$slide_dir"
            mkdir -p "$output_dir"
            
            # Generate HTML only
            marp --html "$file" --allow-local-files -o "$output_dir/index.html"
            
            # Copy images if exists
            if [ -d "$slide_dir/images" ]; then
              cp -r "$slide_dir/images" "$output_dir/"
            fi
            
            echo "✅ Built: $output_dir/index.html"
          done
      
      - name: Generate slides index page
        run: |
          mkdir -p build
          
          # Find all slide directories
          SLIDE_DIRS=$(find slides -type d -name "20*" -maxdepth 1 2>/dev/null | sort -r || true)
          
          # Generate index.html with slides list
          cat > build/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="ja">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Marp Slides Generator - スライド一覧</title>
            <style>
              /* デザイン庁スタイルに基づくデザインシステム */
              :root {
                --color-primary: #0969DA;
                --color-primary-hover: #0550AE;
                --color-gray-50: #F8F9FA;
                --color-gray-100: #F1F3F4;
                --color-gray-500: #6A737D;
                --color-gray-900: #24292F;
                --font-size-h1: 2rem;
                --font-size-body: 1rem;
                --font-size-small: 0.875rem;
                --spacing-2: 0.5rem;
                --spacing-3: 0.75rem;
                --spacing-4: 1rem;
                --spacing-6: 1.5rem;
                --spacing-8: 2rem;
                --border-radius: 0.5rem;
              }
              
              * {
                box-sizing: border-box;
              }
              
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', Roboto, sans-serif;
                line-height: 1.6;
                color: var(--color-gray-900);
                background-color: var(--color-gray-50);
                margin: 0;
                padding: var(--spacing-4);
              }
              
              .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                padding: var(--spacing-8);
                border-radius: var(--border-radius);
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
              }
              
              .header {
                text-align: center;
                margin-bottom: var(--spacing-8);
                padding-bottom: var(--spacing-6);
                border-bottom: 1px solid var(--color-gray-100);
              }
              
              h1 {
                font-size: var(--font-size-h1);
                font-weight: 700;
                color: var(--color-gray-900);
                margin: 0 0 var(--spacing-3) 0;
                letter-spacing: -0.025em;
              }
              
              .subtitle {
                color: var(--color-gray-500);
                font-size: var(--font-size-body);
                margin: 0;
              }
              
              .slides-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: var(--spacing-6);
              }
              
              .slide-card {
                background: white;
                border: 1px solid var(--color-gray-100);
                border-radius: var(--border-radius);
                padding: var(--spacing-6);
                transition: all 0.2s ease;
              }
              
              .slide-card:hover {
                border-color: var(--color-primary);
                box-shadow: 0 4px 12px rgba(9, 105, 218, 0.1);
              }
              
              .slide-title {
                font-size: 1.125rem;
                font-weight: 600;
                color: var(--color-gray-900);
                margin: 0 0 var(--spacing-2) 0;
              }
              
              .slide-date {
                color: var(--color-gray-500);
                font-size: var(--font-size-small);
                margin: 0 0 var(--spacing-4) 0;
              }
              
              .slide-links {
                display: flex;
                gap: var(--spacing-3);
              }
              
              .btn {
                display: inline-flex;
                align-items: center;
                padding: var(--spacing-2) var(--spacing-4);
                border-radius: var(--border-radius);
                text-decoration: none;
                font-size: var(--font-size-small);
                font-weight: 500;
                transition: all 0.2s ease;
                border: 1px solid;
              }
              
              .btn-primary {
                background-color: var(--color-primary);
                color: white;
                border-color: var(--color-primary);
              }
              
              .btn-primary:hover {
                background-color: var(--color-primary-hover);
                border-color: var(--color-primary-hover);
              }
              
              .no-slides {
                text-align: center;
                padding: var(--spacing-8);
                color: var(--color-gray-500);
              }
              
              @media (max-width: 768px) {
                body {
                  padding: var(--spacing-2);
                }
                .container {
                  padding: var(--spacing-4);
                }
                .slides-grid {
                  grid-template-columns: 1fr;
                  gap: var(--spacing-4);
                }
              }
            </style>
          </head>
          <body>
            <div class="container">
              <header class="header">
                <h1>Marp Slides Generator</h1>
                <p class="subtitle">プレゼンテーションスライド一覧</p>
              </header>
          EOF
          
          # Add slides list or no-slides message
          if [ -n "$SLIDE_DIRS" ]; then
            echo '      <div class="slides-grid">' >> build/index.html
            
            for dir in $SLIDE_DIRS; do
              # Extract date and title from directory name
              BASENAME=$(basename "$dir")
              DATE_PART=$(echo "$BASENAME" | cut -d'-' -f1-3)
              TITLE_PART=$(echo "$BASENAME" | cut -d'-' -f4- | tr '-' ' ')
              
              # Format date
              YEAR=$(echo "$DATE_PART" | cut -d'-' -f1)
              MONTH=$(echo "$DATE_PART" | cut -d'-' -f2)
              DAY=$(echo "$DATE_PART" | cut -d'-' -f3)
              FORMATTED_DATE="$YEAR年${MONTH}月${DAY}日"
              
              # Check if built files exist
              HTML_EXISTS=""
              if [ -f "build/$dir/index.html" ]; then
                HTML_EXISTS="true"
              fi
              
              echo '        <div class="slide-card">' >> build/index.html
              echo "          <div class=\"slide-title\">$TITLE_PART</div>" >> build/index.html
              echo "          <div class=\"slide-date\">$FORMATTED_DATE</div>" >> build/index.html
              echo '          <div class="slide-links">' >> build/index.html
              
              if [ "$HTML_EXISTS" = "true" ]; then
                echo "            <a href=\"$dir/index.html\" class=\"btn btn-primary\">HTMLスライド</a>" >> build/index.html
              else
                echo "            <span style=\"color: var(--color-gray-500);\">ビルド待ち...</span>" >> build/index.html
              fi
              
              echo '          </div>' >> build/index.html
              echo '        </div>' >> build/index.html
            done
            
            echo '      </div>' >> build/index.html
          else
            cat >> build/index.html << 'EOF'
              <div class="no-slides">
                <p>まだスライドがありません</p>
                <p>スライドを作成すると、ここに表示されます。</p>
              </div>
          EOF
          fi
          
          # Add footer
          cat >> build/index.html << 'EOF'
            </div>
          </body>
          </html>
          EOF
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4