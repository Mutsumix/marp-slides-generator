name: Generate Slides from Issue

on:
  issues:
    types: [opened]

jobs:
  generate-slide:
    if: contains(github.event.issue.labels.*.name, 'slide-request')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: |
          npm install
      
      - name: Parse issue and generate slide
        id: generate
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Parse issue body
            const issueBody = context.payload.issue.body;
            const issueNumber = context.payload.issue.number;
            
            // Extract fields from issue template
            const extractField = (fieldName) => {
              const regex = new RegExp('### ' + fieldName + '[\\s\\S]*?(?:###|$)');
              const match = issueBody.match(regex);
              if (!match) return '';
              return match[0].replace(new RegExp('### ' + fieldName + '\\s*'), '')
                            .replace(/### .*$/m, '')
                            .trim();
            };
            
            // Parse the form data
            const title = extractField('ğŸ“ ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆè‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ï¼‰');
            const titleJa = extractField('ğŸ“‹ ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆæ—¥æœ¬èªï¼‰');
            const theme = extractField('ğŸ¨ ãƒ†ãƒ¼ãƒ').replace(/ï¼ˆ.*ï¼‰/, '').toLowerCase();
            const duration = extractField('â±ï¸ ç™ºè¡¨æ™‚é–“').match(/\d+/)[0];
            const presenter = extractField('ğŸ‘¤ ç™ºè¡¨è€…å');
            const organization = extractField('ğŸ¢ æ‰€å±çµ„ç¹”ï¼ˆä»»æ„ï¼‰');
            const date = extractField('ğŸ“… ç™ºè¡¨æ—¥') || new Date().toISOString().split('T')[0];
            const content = extractField('ğŸ“ ã‚¹ãƒ©ã‚¤ãƒ‰å†…å®¹');
            const speakerNotes = extractField('ğŸ’¬ å…¨ä½“çš„ãªã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãƒãƒ¼ãƒˆï¼ˆä»»æ„ï¼‰');
            
            // Create directory name
            const today = new Date().toISOString().split('T')[0];
            const dirName = today + '-' + title;
            const slideDir = path.join('slides', dirName);
            
            // Create directories
            fs.mkdirSync(slideDir, { recursive: true });
            fs.mkdirSync(path.join(slideDir, 'images'), { recursive: true });
            
            // Generate slide content
            let slideContent = '---\n' +
              'marp: true\n' +
              'theme: ' + (theme === 'default' ? 'default' : theme) + '\n' +
              'paginate: true\n' +
              '---\n\n' +
              '# ' + titleJa + '\n\n' +
              (organization ? presenter + ' - ' + organization : presenter) + '\n' +
              date + '\n\n' +
              '---\n\n';
            
            // Add content from issue
            if (content) {
              slideContent += content;
            } else {
              // Use template based on duration
              const templatePath = path.join('templates', duration + 'min-template.md');
              if (fs.existsSync(templatePath)) {
                const template = fs.readFileSync(templatePath, 'utf8');
                slideContent += template.split('---').slice(2).join('---');
              }
            }
            
            // Add global speaker notes if provided
            if (speakerNotes) {
              slideContent += '\n\n<!-- \n' +
                'å…¨ä½“ãƒ¡ãƒ¢:\n' +
                speakerNotes + '\n' +
                '-->';
            }
            
            // Write slide file
            const slidePath = path.join(slideDir, 'slide.md');
            fs.writeFileSync(slidePath, slideContent);
            
            // Output for next steps
            core.setOutput('slide_dir', dirName);
            core.setOutput('slide_title', titleJa);
            core.setOutput('issue_number', issueNumber);
            
            return { dirName, titleJa };
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            feat: Add new slide "${{ steps.generate.outputs.slide_title }}"
            
            - Created from issue #${{ steps.generate.outputs.issue_number }}
            - Directory: slides/${{ steps.generate.outputs.slide_dir }}
            
            Closes #${{ steps.generate.outputs.issue_number }}
          branch: slides/${{ steps.generate.outputs.slide_dir }}
          title: "ğŸ“Š New Slide: ${{ steps.generate.outputs.slide_title }}"
          body: |
            ## ğŸ“Š æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸ
            
            **ã‚¿ã‚¤ãƒˆãƒ«**: ${{ steps.generate.outputs.slide_title }}
            **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: `slides/${{ steps.generate.outputs.slide_dir }}/`
            **Issue**: #${{ steps.generate.outputs.issue_number }}
            
            ### ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
            
            1. ã“ã®PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„
            2. å¿…è¦ã«å¿œã˜ã¦ã‚¹ãƒ©ã‚¤ãƒ‰å†…å®¹ã‚’ç·¨é›†ã—ã¦ãã ã•ã„
            3. ãƒãƒ¼ã‚¸ã™ã‚‹ã¨è‡ªå‹•çš„ã«HTML/PDFãŒç”Ÿæˆã•ã‚Œã¾ã™
            
            ### ğŸ”— ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            
            ãƒãƒ¼ã‚¸å¾Œã€ä»¥ä¸‹ã®URLã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒç¢ºèªã§ãã¾ã™ï¼š
            - HTML: `https://[your-username].github.io/[repo-name]/slides/${{ steps.generate.outputs.slide_dir }}/`
            
            ---
            
            *This PR was automatically generated from issue #${{ steps.generate.outputs.issue_number }}*
          labels: |
            slides
            automated
          assignees: ${{ github.actor }}
      
      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.generate.outputs.issue_number }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: '## âœ… ã‚¹ãƒ©ã‚¤ãƒ‰ã®ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\n' +
                'Pull RequestãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„ï¼š\n\n' +
                'ğŸ”— **Pull Request**: #' + (context.payload.pull_request?.number || 'Creating...') + '\n' +
                'ğŸ“ **ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: `slides/${{ steps.generate.outputs.slide_dir }}/`\n\n' +
                '### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n' +
                '1. PRã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ã€å¿…è¦ã«å¿œã˜ã¦ç·¨é›†\n' +
                '2. PRã‚’ãƒãƒ¼ã‚¸ã—ã¦HTML/PDFã‚’è‡ªå‹•ç”Ÿæˆ\n' +
                '3. GitHub Pagesã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèª\n\n' +
                'ã”ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°ã€ã“ã®Issueã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚'
            });
            
            // Close the issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed'
            });